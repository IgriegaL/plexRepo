name: Actualizar Im√°genes Docker

on:
  schedule:
    # Ejecutar semanalmente los lunes a las 3 AM
    - cron: '0 3 * * 1'
  workflow_dispatch:  # Permitir ejecuci√≥n manual

jobs:
  check-updates:
    name: Verificar Actualizaciones
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v4
      
      - name: Verificar nuevas versiones
        id: check
        run: |
          echo "üìä Verificando actualizaciones de im√°genes Docker..."
          
          # Extraer im√°genes
          IMAGES=$(grep -E "^\s+image:" docker-compose*.yml | awk '{print $2}' | sort -u)
          
          UPDATES_AVAILABLE=false
          
          for image in $IMAGES; do
            echo "Verificando: $image"
            
            # Pull la imagen para ver si hay actualizaci√≥n
            if docker pull "$image" 2>&1 | grep -q "Downloaded newer image"; then
              echo "üÜï Actualizaci√≥n disponible para: $image"
              UPDATES_AVAILABLE=true
            else
              echo "‚úÖ $image est√° actualizado"
            fi
          done
          
          echo "updates_available=$UPDATES_AVAILABLE" >> $GITHUB_OUTPUT
      
      - name: Crear Issue si hay actualizaciones
        if: steps.check.outputs.updates_available == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'üîÑ Actualizaciones de im√°genes Docker disponibles',
              body: `Se han detectado actualizaciones para las im√°genes Docker.
              
              Por favor, revisa y actualiza las im√°genes ejecutando:
              \`\`\`bash
              docker-compose pull
              docker-compose up -d
              \`\`\`
              
              O ejecuta el script de actualizaci√≥n:
              \`\`\`bash
              ./scripts/update-images.sh
              \`\`\`
              
              **Nota:** Revisa los changelogs antes de actualizar en producci√≥n.`,
              labels: ['dependencies', 'enhancement']
            })

  test-latest:
    name: Probar con √öltimas Versiones
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'
    
    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v4
      
      - name: Crear .env de prueba
        run: |
          cp .env.example .env
          # Configurar valores de prueba
          sed -i 's/PLEX_CLAIM=.*/PLEX_CLAIM=claim-test/' .env
          sed -i 's/GRAFANA_ADMIN_PASSWORD=.*/GRAFANA_ADMIN_PASSWORD=testpass123/' .env
      
      - name: Pull √∫ltimas im√°genes
        run: docker-compose pull
      
      - name: Validar configuraci√≥n
        run: docker-compose config
      
      - name: Iniciar servicios
        run: docker-compose up -d
      
      - name: Esperar a que servicios inicien
        run: sleep 60
      
      - name: Verificar servicios
        run: |
          docker-compose ps
          
          # Verificar que los servicios est√©n corriendo
          SERVICES=$(docker-compose ps --services)
          for service in $SERVICES; do
            STATUS=$(docker-compose ps $service | grep -v "Name" | awk '{print $4}')
            if [[ "$STATUS" != "Up" ]]; then
              echo "‚ùå ERROR: $service no est√° corriendo"
              docker-compose logs $service
              exit 1
            fi
            echo "‚úÖ $service est√° corriendo"
          done
      
      - name: Limpiar
        if: always()
        run: docker-compose down -v
