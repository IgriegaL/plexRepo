---
###############################################################
#                   Authelia configuration                    #
###############################################################

theme: dark

server:
  host: 0.0.0.0
  port: 9091

log:
  level: info
  format: text

totp:
  issuer: MediaServer
  period: 30
  skew: 1

authentication_backend:
  file:
    path: /config/users_database.yml
    password:
      algorithm: argon2id
      iterations: 1
      salt_length: 16
      parallelism: 8
      memory: 64

access_control:
  default_policy: deny
  
  rules:
    # Bypass para healthchecks
    - domain:
        - "*.${DOMAIN}"
      policy: bypass
      resources:
        - "^/api/health$"
        - "^/health$"
        - "^/ping$"
    
    # Plex - acceso público (ya tiene su propia auth)
    - domain:
        - "plex.${DOMAIN}"
      policy: bypass
    
    # Overseerr - requiere autenticación
    - domain:
        - "overseerr.${DOMAIN}"
        - "request.${DOMAIN}"
      policy: two_factor
    
    # Servicios de gestión - requiere 2FA
    - domain:
        - "sonarr.${DOMAIN}"
        - "radarr.${DOMAIN}"
        - "prowlarr.${DOMAIN}"
        - "bazarr.${DOMAIN}"
      policy: two_factor
      subject:
        - "group:admins"
    
    # Monitoreo - requiere 2FA
    - domain:
        - "grafana.${DOMAIN}"
        - "prometheus.${DOMAIN}"
      policy: two_factor
      subject:
        - "group:admins"
    
    # Servicios avanzados - requiere 2FA
    - domain:
        - "traefik.${DOMAIN}"
        - "tautulli.${DOMAIN}"
        - "qbittorrent.${DOMAIN}"
      policy: two_factor
      subject:
        - "group:admins"

session:
  name: authelia_session
  domain: ${DOMAIN}
  same_site: lax
  expiration: 1h
  inactivity: 5m
  remember_me_duration: 1M

regulation:
  max_retries: 5
  find_time: 2m
  ban_time: 10m

storage:
  local:
    path: /config/db.sqlite3

notifier:
  filesystem:
    filename: /config/notification.txt
  # Para producción, usar SMTP:
  # smtp:
  #   username: ${SMTP_USERNAME}
  #   password: ${SMTP_PASSWORD}
  #   host: ${SMTP_HOST}
  #   port: ${SMTP_PORT}
  #   sender: authelia@${DOMAIN}
